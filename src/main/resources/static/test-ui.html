<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>약국 통합 웹 UI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 30px; }
        pre { background: #f8f9fa; padding: 15px; border: 1px solid #ccc; border-radius: 5px; white-space: pre-wrap; }
        .section { margin-bottom: 60px; }
    </style>
</head>
<body>
<div class="container">
    <h1 class="mb-5">💊 약국 통합 웹 UI</h1>

    <!-- 약 목록 조회 -->
    <div class="section">
        <h4>📦 약 목록 조회</h4>
        <button class="btn btn-primary mb-2" onclick="loadDrugList()">조회</button>
        <table class="table table-bordered">
            <thead><tr><th>약품 ID</th><th>약품명</th><th>재고</th></tr></thead>
            <tbody id="drugTable"></tbody>
        </table>
    </div>

    <!-- 유통기한 임박 약품 조회 -->
    <div class="section">
        <h4>⏰ 유통기한 임박</h4>
        <button class="btn btn-warning mb-2" onclick="loadExpiring()">조회</button>
        <table class="table">
            <thead><tr><th>약품명</th><th>유통기한</th><th>재고</th><th>남은 일수</th></tr></thead>
            <tbody id="expiringTable"></tbody>
        </table>
    </div>

    <!-- 일반약 주문 -->
    <div class="section">
        <h4>🛒 일반약 주문</h4>
        <input class="form-control mb-2" id="otcName" placeholder="이름">
        <input class="form-control mb-2" id="otcPhone" placeholder="전화번호 뒷 4자리">
        <input class="form-control mb-2" id="otcDrug" placeholder="약품명">
        <input class="form-control mb-2" id="otcQty" type="number" placeholder="수량" value="1">
        <input class="form-control mb-2" id="otcDate" type="date">
        <button class="btn btn-success" onclick="orderOtc()">주문</button>
        <pre id="otcResult" class="mt-3">- 결과 -</pre>
    </div>

    <!-- 처방약 주문 -->
    <div class="section">
        <h4>🧾 처방약 조제</h4>
        <input class="form-control mb-2" id="rxName" placeholder="이름">
        <input class="form-control mb-2" id="rxPhone" placeholder="전화번호 뒷 4자리">
        <input class="form-control mb-2" id="rxBirth" type="date" placeholder="생년월일">
        <input class="form-control mb-2" id="rxGender" placeholder="성별 (남/여)">
        <input class="form-control mb-2" id="rxAddress" placeholder="주소">
        <input class="form-control mb-2" id="rxAllergy" placeholder="알러지 정보">
        <input class="form-control mb-2" id="rxDoctor" placeholder="의사명">
        <input class="form-control mb-2" id="rxHospital" placeholder="병원명">
        <input class="form-control mb-2" id="rxIssuedDate" type="date" placeholder="처방일자">
        <input class="form-control mb-2" id="rxSaleDate" type="date" placeholder="조제일자">
        <textarea class="form-control mb-2" id="rxItemsJson" placeholder='약품 JSON 배열: [{"drugId":1,"quantity":2,"dosage":"1일3회1정","medicGuide":"식후"}]'></textarea>
        <button class="btn btn-success" onclick="orderPrescription()">조제 처리</button>
        <pre id="rxResult" class="mt-3">- 결과 -</pre>
    </div>

    <!-- 입고 등록 -->
    <div class="section">
        <h4>📥 입고 등록</h4>
        <input class="form-control mb-2" id="inDrug" placeholder="약품명">
        <input class="form-control mb-2" id="inQty" type="number" placeholder="수량">
        <input class="form-control mb-2" id="inPrice" type="number" placeholder="단가">
        <input class="form-control mb-2" id="inDate" type="date" placeholder="입고일">
        <input class="form-control mb-2" id="inExpire" type="date" placeholder="유통기한">
        <input class="form-control mb-2" id="inSupplier" placeholder="공급처">
        <button class="btn btn-secondary" onclick="registerPurchase()">등록</button>
        <pre id="inResult" class="mt-3">- 결과 -</pre>
    </div>

    <!-- 매출 통계 조회 -->
    <div class="section">
        <h4>📈 월간 매출 통계</h4>
        <input class="form-control mb-2" id="statYear" placeholder="연도" value="2025">
        <input class="form-control mb-2" id="statMonth" placeholder="월" value="6">
        <button class="btn btn-info" onclick="loadStats()">조회</button>
        <pre id="statResult" class="mt-3">- 결과 -</pre>
    </div>

    <!-- 환자 복약 이력 조회 -->
    <div class="section">
        <h4>📁 복약 이력 조회</h4>
        <input class="form-control mb-2" id="histName" placeholder="이름">
        <input class="form-control mb-2" id="histPhone" placeholder="전화번호 뒷 4자리">
        <button class="btn btn-dark" onclick="loadHistory()">조회</button>
        <pre id="histResult" class="mt-3">- 결과 -</pre>
    </div>

    <!-- 일반약 주문 취소 -->
    <div class="section">
        <h4>🗑 일반약 주문 취소</h4>
        <input class="form-control mb-2" id="cancelOrderId" placeholder="order_drug_id 입력">
        <button class="btn btn-danger" onclick="cancelOrder()">삭제</button>
        <pre id="cancelResult" class="mt-3">- 결과 -</pre>
    </div>

    <!-- 약품 키워드 검색 -->
    <div class="section">
        <h4>🔍 약품 검색</h4>
        <input class="form-control mb-2" id="searchKeyword" placeholder="이름, 제조사, 효능 등">
        <button class="btn btn-outline-primary" onclick="searchDrug()">검색</button>
        <pre id="searchResult" class="mt-3">- 결과 -</pre>
    </div>
</div>


<script>
    async function loadDrugList() {
      const res = await fetch("/view/drug-stock");
      const data = await res.json();
      const tbody = document.getElementById("drugTable");
      tbody.innerHTML = data.map(d => `<tr><td>${d.drug_id}</td><td>${d.drug_name}</td><td>${d.stock}</td></tr>`).join("");
    }

    async function loadExpiring() {
      const res = await fetch("/view/expiring");
      const data = await res.json();
      const tbody = document.getElementById("expiringTable");
      tbody.innerHTML = data.map(d => `<tr><td>${d.drug_name}</td><td>${d.expiration_date}</td><td>${d.remaining_quantity}</td><td>${d.days_left}</td></tr>`).join("");
    }

    async function orderOtc() {
      const payload = {
        name: document.getElementById("otcName").value,
        phoneLast4: document.getElementById("otcPhone").value,
        saleDate: document.getElementById("otcDate").value,
        items: [
          {
            drugName: document.getElementById("otcDrug").value,
            quantity: parseInt(document.getElementById("otcQty").value)
          }
        ]
      };
        async function orderPrescription() {
    const payload = {
      isPrescription: true,
      name: document.getElementById("rxName").value,
      phone: document.getElementById("rxPhone").value,
      birthDate: document.getElementById("rxBirth").value,
      gender: document.getElementById("rxGender").value,
      address: document.getElementById("rxAddress").value,
      allergy: document.getElementById("rxAllergy").value,
      doctor: document.getElementById("rxDoctor").value,
      hospital: document.getElementById("rxHospital").value,
      issuedDate: document.getElementById("rxIssuedDate").value,
      saleDate: document.getElementById("rxSaleDate").value,
      items: JSON.parse(document.getElementById("rxItemsJson").value)
    };

  async function orderPrescription() {
    const payload = {
      isPrescription: true,
      name: document.getElementById("rxName").value,
      phone: document.getElementById("rxPhone").value,
      birthDate: document.getElementById("rxBirth").value,
      gender: document.getElementById("rxGender").value,
      address: document.getElementById("rxAddress").value,
      allergy: document.getElementById("rxAllergy").value,
      doctor: document.getElementById("rxDoctor").value,
      hospital: document.getElementById("rxHospital").value,
      issuedDate: document.getElementById("rxIssuedDate").value,
      saleDate: document.getElementById("rxSaleDate").value,
      items: JSON.parse(document.getElementById("rxItemsJson").value)
    };

    const res = await fetch("/orders/prescription", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    const result = await res.json();
    document.getElementById("rxResult").textContent = JSON.stringify(result, null, 2);
  }

    const res = await fetch("/orders/prescription", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    const result = await res.json();
    document.getElementById("rxResult").textContent = JSON.stringify(result, null, 2);
  }

      const res = await fetch("/orders/otc", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const result = await res.json();
      document.getElementById("otcResult").textContent = JSON.stringify(result, null, 2);
    }

    async function loadStats() {
      const y = document.getElementById("statYear").value;
      const m = document.getElementById("statMonth").value;
      const res = await fetch(`/stats/monthly?year=${y}&month=${m}`);
      const result = await res.json();
      document.getElementById("statResult").textContent = JSON.stringify(result, null, 2);
    }

    async function registerPurchase() {
      const payload = {
        drugName: document.getElementById("inDrug").value,
        quantity: parseInt(document.getElementById("inQty").value),
        unitPrice: parseInt(document.getElementById("inPrice").value),
        purchaseDate: document.getElementById("inDate").value,
        expirationDate: document.getElementById("inExpire").value,
        supplier: document.getElementById("inSupplier").value
      };

      const res = await fetch("/purchases", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const result = await res.json();
      document.getElementById("inResult").textContent = JSON.stringify(result, null, 2);
    }

    async function loadHistory() {
      const name = document.getElementById("histName").value;
      const phone = document.getElementById("histPhone").value;
      const res = await fetch(`/view/patient-history?name=${encodeURIComponent(name)}&phoneLast4=${encodeURIComponent(phone)}`);
      const result = await res.json();
      document.getElementById("histResult").textContent = JSON.stringify(result, null, 2);
    }

    async function cancelOrder() {
      const id = document.getElementById("cancelOrderId").value;
      const res = await fetch(`/delete-od/${id}`, { method: "DELETE" });
      const result = await res.json();
      document.getElementById("cancelResult").textContent = JSON.stringify(result, null, 2);
    }

    async function searchDrug() {
      const keyword = document.getElementById("searchKeyword").value;
      const res = await fetch(`/view/search?keyword=${encodeURIComponent(keyword)}`);
      const result = await res.json();
      document.getElementById("searchResult").textContent = JSON.stringify(result, null, 2);
    }
</script>



</body>
</html>

