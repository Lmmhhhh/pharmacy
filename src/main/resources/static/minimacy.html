<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì•½êµ­ í†µí•© ì›¹ UI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 30px; }
        .result-box {
          background: #f8f9fa;
          padding: 15px;
          border: 1px solid #ccc;
          border-radius: 5px;
          white-space: pre-wrap;
        }
        .section { margin-bottom: 60px; }
        #alertArea {
          position: fixed;
          top: 10px;
          right: 10px;
          z-index: 9999;
        }
    </style>
</head>
<body>
<div class="container">
    <h1 class="mb-5">ğŸ’ŠMiniMacy : MinipharMacyğŸ’Š</h1>
    <div id="alertArea"></div>

    <!-- ğŸ›’ ì¼ë°˜ì•½ ì£¼ë¬¸ -->
    <div class="section">
        <h4>ğŸ›’ ì¼ë°˜ì•½ ì£¼ë¬¸</h4>
        <input class="form-control mb-2" id="otcName" placeholder="ì´ë¦„">
        <input class="form-control mb-2" id="otcPhone" placeholder="ì „í™”ë²ˆí˜¸ ë’· 4ìë¦¬">
        <input class="form-control mb-2" id="otcDrug" placeholder="ì•½í’ˆëª…">
        <input class="form-control mb-2" id="otcQty" type="number" value="1" placeholder="ìˆ˜ëŸ‰">
        <input class="form-control mb-2" id="otcDate" type="date">
        <button class="btn btn-success" onclick="orderOtc()">ì£¼ë¬¸</button>
        <div id="otcResult" class="result-box mt-3">- ê²°ê³¼ -</div>
    </div>

    <!-- ğŸ§¾ ì²˜ë°©ì•½ ì£¼ë¬¸ -->
    <div class="section">
        <h4>ğŸ§¾ ì²˜ë°©ì•½ ì¡°ì œ</h4>
        <input class="form-control mb-2" id="rxName" placeholder="ì´ë¦„">
        <input class="form-control mb-2" id="rxPhone" placeholder="ì „í™”ë²ˆí˜¸ ë’· 4ìë¦¬">
        <input class="form-control mb-2" id="rxBirth" type="date" placeholder="ìƒë…„ì›”ì¼">
        <input class="form-control mb-2" id="rxGender" placeholder="ì„±ë³„ (ë‚¨/ì—¬)">
        <input class="form-control mb-2" id="rxAddress" placeholder="ì£¼ì†Œ">
        <input class="form-control mb-2" id="rxAllergy" placeholder="ì•ŒëŸ¬ì§€ ì •ë³´">
        <input class="form-control mb-2" id="rxDoctor" placeholder="ì˜ì‚¬ëª…">
        <input class="form-control mb-2" id="rxHospital" placeholder="ë³‘ì›ëª…">
        <input class="form-control mb-2" id="rxIssuedDate" type="date" placeholder="ì²˜ë°©ì¼ì">
        <input class="form-control mb-2" id="rxSaleDate" type="date" placeholder="ì¡°ì œì¼ì">
        <textarea class="form-control mb-2" id="rxItemsJson" placeholder='ì•½í’ˆ JSON ë°°ì—´: [{"drugId":1,"quantity":2,"dosage":"1ì¼3íšŒ1ì •","medicGuide":"ì‹í›„"}]'></textarea>
        <button class="btn btn-success" onclick="orderPrescription()">ì¡°ì œ ì²˜ë¦¬</button>
        <div id="rxResult" class="result-box mt-3">- ê²°ê³¼ -</div>
    </div>

    <!-- ğŸ“ˆ í†µê³„ -->
    <div class="section">
        <h4>ğŸ“ˆ ì›”ê°„ ë§¤ì¶œ í†µê³„</h4>
        <input class="form-control mb-2" id="statYear" value="2025" placeholder="ì—°ë„">
        <input class="form-control mb-2" id="statMonth" value="6" placeholder="ì›”">
        <button class="btn btn-info" onclick="loadStats()">ì¡°íšŒ</button>
        <div id="statResult" class="result-box mt-3">- ê²°ê³¼ -</div>
    </div>

    <!-- ğŸ“ ë³µì•½ ì´ë ¥ -->
    <div class="section">
        <h4>ğŸ“ ë³µì•½ ì´ë ¥ ì¡°íšŒ</h4>
        <input class="form-control mb-2" id="histName" placeholder="ì´ë¦„">
        <input class="form-control mb-2" id="histPhone" placeholder="ì „í™”ë²ˆí˜¸ ë’· 4ìë¦¬">
        <button class="btn btn-dark" onclick="loadHistory()">ì¡°íšŒ</button>
        <div id="histResult" class="result-box mt-3">- ê²°ê³¼ -</div>
    </div>

    <!-- ğŸ—‘ ì¼ë°˜ì•½ ì£¼ë¬¸ ì·¨ì†Œ -->
    <div class="section">
        <h4>ğŸ—‘ ì¼ë°˜ì•½ ì£¼ë¬¸ ì·¨ì†Œ</h4>
        <input class="form-control mb-2" id="cancelOrderId" placeholder="order_drug_id ì…ë ¥">
        <button class="btn btn-danger" onclick="cancelOrder()">ì‚­ì œ</button>
        <div id="cancelResult" class="result-box mt-3">- ê²°ê³¼ -</div>
    </div>

    <!-- ğŸ” ì•½í’ˆ ê²€ìƒ‰ -->
    <div class="section">
        <h4>ğŸ” ì•½í’ˆ ê²€ìƒ‰</h4>
        <input class="form-control mb-2" id="searchKeyword" placeholder="ì´ë¦„, ì œì¡°ì‚¬, íš¨ëŠ¥ ë“±">
        <button class="btn btn-outline-primary" onclick="searchDrug()">ê²€ìƒ‰</button>
        <div id="searchResult" class="result-box mt-3">- ê²°ê³¼ -</div>
    </div>

    <!-- ğŸ“¦ ì•½í’ˆ ì¬ê³  ì „ì²´ ì¡°íšŒ -->
    <div class="section">
        <h4>ğŸ“¦ ì•½í’ˆ ì¬ê³  ì¡°íšŒ</h4>
        <button class="btn btn-primary mb-2" onclick="loadDrugStock()">ì¡°íšŒ</button>
        <div id="stockResult" class="result-box mt-3">- ê²°ê³¼ -</div>
    </div>

    <!-- â° ìœ í†µê¸°í•œ ì„ë°• ì•½í’ˆ -->
    <div class="section">
        <h4>â° ìœ í†µê¸°í•œ ì„ë°• ì•½í’ˆ</h4>
        <button class="btn btn-warning mb-2" onclick="loadExpiring()">ì¡°íšŒ</button>
        <div id="expiringResult" class="result-box mt-3">- ê²°ê³¼ -</div>
    </div>

    <!-- ğŸ“‰ ì¬ê³  ë¶€ì¡± ì•½í’ˆ -->
    <div class="section">
        <h4>ğŸ“‰ ì¬ê³  ë¶€ì¡± ì•½í’ˆ</h4>
        <button class="btn btn-danger mb-2" onclick="loadLowStock()">ì¡°íšŒ</button>
        <div id="lowStockResult" class="result-box mt-3">- ê²°ê³¼ -</div>
    </div>
</div>

<script>
    function displayAsTable(containerId, dataArray) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';

      if (!Array.isArray(dataArray) || dataArray.length === 0) {
        container.innerHTML = '<div>í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      const table = document.createElement('table');
      table.className = 'table table-bordered';

      const thead = document.createElement('thead');
      const headerRow = document.createElement('tr');
      Object.keys(dataArray[0]).forEach(key => {
        const th = document.createElement('th');
        th.textContent = key;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      dataArray.forEach(item => {
        const row = document.createElement('tr');
        Object.values(item).forEach(val => {
          const td = document.createElement('td');
          td.textContent = val;
          row.appendChild(td);
        });
        tbody.appendChild(row);
      });
      table.appendChild(tbody);
      container.appendChild(table);
    }

    // --- ê¸°ëŠ¥ë³„ ìš”ì²­ í•¨ìˆ˜ë“¤ ---
    async function orderOtc() {
      const payload = {
        name: document.getElementById("otcName").value,
        phoneLast4: document.getElementById("otcPhone").value,
        saleDate: document.getElementById("otcDate").value,
        items: [{
          drugName: document.getElementById("otcDrug").value,
          quantity: parseInt(document.getElementById("otcQty").value)
        }]
      };
      const res = await fetch("/orders/otc", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const result = await res.json();
      document.getElementById("otcResult").textContent = JSON.stringify(result, null, 2);
    }

    async function orderPrescription() {
      const payload = {
        isPrescription: true,
        name: document.getElementById("rxName").value,
        phone: document.getElementById("rxPhone").value,
        birthDate: document.getElementById("rxBirth").value,
        gender: document.getElementById("rxGender").value,
        address: document.getElementById("rxAddress").value,
        allergy: document.getElementById("rxAllergy").value,
        doctor: document.getElementById("rxDoctor").value,
        hospital: document.getElementById("rxHospital").value,
        issuedDate: document.getElementById("rxIssuedDate").value,
        saleDate: document.getElementById("rxSaleDate").value,
        items: JSON.parse(document.getElementById("rxItemsJson").value)
      };
      const res = await fetch("/orders/prescription", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const result = await res.json();
      document.getElementById("rxResult").textContent = JSON.stringify(result, null, 2);
    }

    async function loadStats() {
      const y = document.getElementById("statYear").value;
      const m = document.getElementById("statMonth").value;
      const res = await fetch(`/stats/monthly?year=${y}&month=${m}`);
      const result = await res.json();
      displayAsTable("statResult", Array.isArray(result) ? result : [result]);
    }

    async function loadHistory() {
      const name = document.getElementById("histName").value;
      const phone = document.getElementById("histPhone").value;
      const res = await fetch(`/view/patient-history?name=${encodeURIComponent(name)}&phoneLast4=${encodeURIComponent(phone)}`);
      const result = await res.json();
      displayAsTable("histResult", result);
    }

    async function cancelOrder() {
      const id = document.getElementById("cancelOrderId").value;
      const res = await fetch(`/delete-od/${id}`, { method: "DELETE" });
      const result = await res.json();
      displayAsTable("cancelResult", Array.isArray(result) ? result : [result]);
    }

    async function searchDrug() {
      const keyword = document.getElementById("searchKeyword").value;
      const res = await fetch(`/view/search?keyword=${encodeURIComponent(keyword)}`);
      const result = await res.json();
      displayAsTable("searchResult", result);
    }

    async function loadDrugStock() {
      const res = await fetch("/view/drug-stock");
      const result = await res.json();
      displayAsTable("stockResult", result);
    }

    async function loadExpiring() {
      const res = await fetch("/view/expiring");
      const result = await res.json();
      displayAsTable("expiringResult", result);
    }

    async function loadLowStock() {
      const res = await fetch("/view/low_stock");
      const result = await res.json();
      displayAsTable("lowStockResult", result);
    }

    async function fetchAlerts() {
      const res = await fetch("/alerts");
      const data = await res.json();
      const area = document.getElementById("alertArea");
      area.innerHTML = '';
      data.reverse().forEach(msg => {
        const div = document.createElement("div");
        div.className = "alert alert-warning mb-2";
        div.textContent = msg;
        area.appendChild(div);
      });
    }
    setInterval(fetchAlerts, 30000);
    fetchAlerts();
</script>
</body>
</html>
