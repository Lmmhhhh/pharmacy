<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>일반약 주문</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 40px; }
        .low-stock { background-color: #ffe6e6; }
    </style>
</head>
<body>

<div class="container">
    <h2 class="mb-4">🛒 일반의약품 주문</h2>

    <div class="card p-4 shadow-sm">
        <form id="orderForm">
            <div class="row mb-3">
                <div class="col">
                    <label class="form-label">이름</label>
                    <input type="text" id="name" class="form-control" required>
                </div>
                <div class="col">
                    <label class="form-label">전화번호 (뒤 4자리)</label>
                    <input type="text" id="phoneLast4" class="form-control" required>
                </div>
                <div class="col">
                    <label class="form-label">판매일자</label>
                    <input type="date" id="saleDate" class="form-control" required>
                </div>
            </div>

            <hr>

            <h5>💊 약품 추가</h5>
            <div class="row g-2 mb-3">
                <div class="col-6">
                    <input type="text" id="drugName" class="form-control" placeholder="약품명 입력">
                </div>
                <div class="col-3">
                    <input type="number" id="quantity" class="form-control" value="1" min="1">
                </div>
                <div class="col-3">
                    <button type="button" class="btn btn-primary w-100" onclick="addItem()">➕ 추가</button>
                </div>
            </div>

            <table class="table table-bordered" id="itemTable">
                <thead>
                <tr class="table-light">
                    <th>약품명</th>
                    <th>수량</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>

            <div class="d-grid mt-4">
                <button type="button" class="btn btn-success btn-lg" onclick="submitOrder()">✅ 주문 등록</button>
            </div>
        </form>
    </div>
</div>

<script>
    const items = [];

    function addItem() {
      const drug = document.getElementById("drugName").value.trim();
      const qty = parseInt(document.getElementById("quantity").value);

      if (!drug || qty < 1) {
        alert("약품명과 수량을 올바르게 입력하세요.");
        return;
      }

      items.push({ drugName: drug, quantity: qty });

      const row = document.createElement("tr");
      row.innerHTML = `<td>${drug}</td><td>${qty}</td>`;
      document.querySelector("#itemTable tbody").appendChild(row);

      document.getElementById("drugName").value = "";
      document.getElementById("quantity").value = 1;
    }

    async function submitOrder() {
      const name = document.getElementById("name").value;
      const phone = document.getElementById("phoneLast4").value;
      const saleDate = document.getElementById("saleDate").value;

      if (!name || !phone || !saleDate || items.length === 0) {
        alert("모든 항목을 입력하고 약품을 추가해주세요.");
        return;
      }

      const payload = {
        name: name,
        phoneLast4: phone,
        saleDate: saleDate,
        items: items
      };

      try {
        const res = await fetch("/orders/otc", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          const err = await res.text();
          throw new Error(err);
        }

        const result = await res.json();
        alert("✅ 주문 완료\n" + result.message);
        location.reload();
      } catch (err) {
        alert("❌ 오류 발생: " + err.message);
      }
    }
</script>

</body>
</html>

